<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login Comprador - GalerÃ­a Virtual</title>
  <link rel="stylesheet" href="Estilos/login.css" />
</head>
<body>

  <!-- NAVBAR UNIVERSAL -->
  <nav class="navbar">
    <h2 class="logo">GalerÃ­a <span>Virtual</span></h2>
    <ul>
      <li><a href="inicio.html">Inicio</a></li>
      <li><a href="Sobre_nosotros.html">Nosotros</a></li>
      <li><a href="Contenido.html">Contenido</a></li>
      <li><a href="publicar.html">Publicar +</a></li>

      <!-- BotÃ³n login (se oculta si hay usuario) -->
      <li><a id="btnLoginNav" href="login.html">Iniciar sesiÃ³n</a></li>

      <!-- AquÃ­ aparecerÃ¡n la foto/nombre cuando haya usuario -->
      <li id="navbarUserBox"></li>
    </ul>
  </nav>

  <!-- LOGIN CARD -->
  <div class="login-card" style="margin-top:110px;">
    <img class="login-logo" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="logo">
    <h2>Acceso Comprador ðŸ›’</h2>

    <form id="loginForm" autocomplete="off">
      <input type="hidden" name="tipo" value="comprador">

      <div class="input-group">
        <span>ðŸ“§</span>
        <input id="email" name="email" type="email" required placeholder="Correo registrado">
      </div>

      <div class="input-group">
        <span>ðŸ”’</span>
        <input id="password" name="password" type="password" required placeholder="ContraseÃ±a">
      </div>

      <button class="btn-submit" type="submit">Entrar</button>
    </form>

    <a class="crear-cuenta" href="registro.html">Â¿No tienes cuenta? Crear cuenta</a>
    <a class="volver" href="login.html" style="display:block;margin-top:8px;">â¬… Volver</a>

    <p id="mensajeError" class="error" style="display:none;margin-top:10px;"></p>
  </div>

  <!-- SCRIPTS -->
  <script>
    // Mostrar usuario en navbar (si existe)
    (function initNavbar() {
      const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
      const btnLogin = document.getElementById("btnLoginNav");
      const box = document.getElementById("navbarUserBox");
      if (!usuario) {
        if (btnLogin) btnLogin.style.display = "inline-block";
        if (box) box.innerHTML = "";
        return;
      }
      if (btnLogin) btnLogin.style.display = "none";
      const foto = usuario.foto && usuario.foto.trim() !== "" ? usuario.foto : "img/default.png";
      box.innerHTML = `<div class="usuario-box" onclick="location.href='cuenta.html'">
                         <img src="${foto}" alt="foto" style="width:35px;height:35px;border-radius:50%;object-fit:cover;border:2px solid #a47bff;">
                         <span style="color:#fff;margin-left:8px;">${usuario.nombre}</span>
                       </div>`;
    })();

    // Submit handler: envÃ­a a Php/login.php (ajusta ruta si hace falta)
    document.getElementById('loginForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const f = new FormData(this);
      try {
        const res = await fetch('Php/login.php', { method: 'POST', body: f });
        const text = await res.text();
        if (!res.ok) {
          document.getElementById('mensajeError').style.display = "block";
          document.getElementById('mensajeError').textContent = text || 'Error en el servidor';
          return;
        }
        // Esperamos JSON con usuario dentro
        let json;
        try { json = JSON.parse(text); } catch (err) {
          document.getElementById('mensajeError').style.display = "block";
          document.getElementById('mensajeError').textContent = 'Respuesta inesperada del servidor';
          return;
        }
        if (json.error) {
          document.getElementById('mensajeError').style.display = "block";
          document.getElementById('mensajeError').textContent = json.error;
          return;
        }
        // Guardar usuario en localStorage y redirigir
        if (json.usuario) localStorage.setItem('usuarioActivo', JSON.stringify(json.usuario));
        window.location.href = 'inicio.html';
      } catch (err) {
        document.getElementById('mensajeError').style.display = "block";
        document.getElementById('mensajeError').textContent = 'No se pudo conectar con el servidor';
      }
    });
  </script>

</body>
</html>
